# ğŸ“‹ PRD - Product Requirements Document

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´å†…å®¹ |
| --- | --- | --- | --- |
| v1.0 | 2025-01-01 | Product Team | åˆå§‹ç‰ˆæœ¬ |
| v1.1 | 2025-01-15 | Product Team | æ ¹æ®ä¿®æ­£æ–‡æ¡£æ›´æ–°: å®ä½¿ç”¨ç¤ºä¾‹, è¡¥å……æ’ä»¶åŒ–æƒé™ç‰¹æ€§ |

## 1. äº§å“æ¦‚è¿°

### 1.1 äº§å“å®šä½

ä¸€ä¸ªåŸºäºSea-ORMçš„ä¼ä¸šçº§Rustæ•°æ®åº“æŠ½è±¡å±‚,ä¸ºåº”ç”¨æä¾›é«˜æ€§èƒ½ã€é«˜å®‰å…¨æ€§ã€å¯æ‰©å±•çš„æ•°æ®è®¿é—®èƒ½åŠ›ã€‚ä½œä¸ºç³»ç»Ÿåº•å±‚åŸºç¡€æ¨¡å—,é€šè¿‡å£°æ˜å¼å®ç®€åŒ–æ•°æ®åº“æ“ä½œ,å†…ç½®æƒé™æ§åˆ¶ã€è¿æ¥æ± ç®¡ç†ã€ç›‘æ§èƒ½åŠ›ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼ä¸»å¼ 

- **å®‰å…¨æ€§ä¼˜å…ˆ**: Sessionæœºåˆ¶é˜²æ­¢è¿æ¥æ³„æ¼,è¡¨çº§æƒé™æ§åˆ¶é˜²æ­¢è¶Šæƒè®¿é—®
- **å¼€å‘æ•ˆç‡**: å£°æ˜å¼å®è‡ªåŠ¨ç”ŸæˆCRUD,Migrationå·¥å…·è‡ªåŠ¨ç®¡ç†schemaå˜æ›´
- **ç”Ÿäº§å°±ç»ª**: å†…ç½®ç›‘æ§æŒ‡æ ‡ã€è¯»å†™åˆ†ç¦»ã€é…ç½®è‡ªåŠ¨ä¿®æ­£
- **æ¸è¿›å¼æ¶æ„**: v1.0æ ¸å¿ƒåŠŸèƒ½ç¨³å®š,é«˜çº§ç‰¹æ€§(åˆ†ç‰‡/ç¼“å­˜)é€šè¿‡feature gateæ‰©å±•

### 1.3 ç›®æ ‡ç”¨æˆ·

- éœ€è¦æ„å»ºé«˜å¯é æ•°æ®è®¿é—®å±‚çš„Ruståç«¯å¼€å‘è€…
- å…³æ³¨å®‰å…¨æ€§å’Œèµ„æºç®¡ç†çš„ä¼ä¸šçº§åº”ç”¨
- éœ€è¦å¹³æ»‘æ‰©å±•åˆ°è¯»å†™åˆ†ç¦»/åˆ†åº“åˆ†è¡¨çš„å›¢é˜Ÿ

------

## 2. åŠŸèƒ½éœ€æ±‚

### 2.1 æ ¸å¿ƒåŠŸèƒ½(v1.0)

#### F1: å¤šæ•°æ®åº“æ”¯æŒ (âœ… å·²å®ç°)

**æè¿°**: é€šè¿‡feature gateæ”¯æŒSQLiteã€PostgreSQLã€MySQL

**å®ç°æ–‡ä»¶**: [lib.rs](file:///home/project/dbnexus/dbnexus/src/lib.rs#L47-L59)

**æ£€æŸ¥ç»“æœ**:
- lib.rs ä¸­å·²å®ç°ç¼–è¯‘æœŸæ•°æ®åº“ç‰¹æ€§äº’æ–¥æ£€æŸ¥è§„åˆ™ âœ…
- æ•°æ®åº“è¿æ¥é€»è¾‘å®Œæ•´å®ç° (Sea-ORM é€‚é…å™¨) âœ…
- æ”¯æŒ SQLiteã€PostgreSQLã€MySQL ä¸‰ç§æ•°æ®åº“ âœ…
- æ— è¿æ¥å­—ç¬¦ä¸²éªŒè¯é€»è¾‘ âš ï¸ éƒ¨åˆ†å®ç° - å·²æœ‰é…ç½®ä¿®æ­£ï¼Œä½†ç¼ºå°‘æ•°æ®åº“ç±»å‹URLéªŒè¯

#### F2: Sessionæœºåˆ¶ (âœ… å·²å®ç°)

**æè¿°**: è¿”å›Sessionè€Œéç›´æ¥è¿æ¥,é€šè¿‡RAIIè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

**å®ç°æ–‡ä»¶**: [pool/mod.rs](file:///home/project/dbnexus/dbnexus/src/pool/mod.rs)

**æ£€æŸ¥ç»“æœ**:
- Session ç»“æ„å·²å®šä¹‰,åŒ…å« RAII ç”Ÿå‘½å‘¨æœŸç®¡ç† âœ…
- å®ç°äº†çœŸå®çš„äº‹åŠ¡ç®¡ç† (ä½¿ç”¨ Sea-ORM çš„ DatabaseTransaction) âœ…
- should_use_master() æ–¹æ³•å·²å®ç°,last_write æ­£ç¡®æ›´æ–° âœ…
- begin_transaction() è°ƒç”¨çœŸå®æ•°æ®åº“äº‹åŠ¡ API âœ…
- commit()/rollback() æäº¤/å›æ»šçœŸå®æ•°æ®åº“äº‹åŠ¡ âœ…
- transaction() æ–¹æ³•æä¾›æ¨èçš„äº‹åŠ¡ä½¿ç”¨æ–¹å¼,è‡ªåŠ¨æäº¤/å›æ»š âœ…
- Drop å®ç°åŒ…å«è¿æ¥å›æ”¶å’Œæœªæäº¤äº‹åŠ¡è­¦å‘Š âœ…
- è¿æ¥æ³„æ¼æµ‹è¯•ç”¨ä¾‹å·²å®ç° âœ…

#### F3: è¡¨çº§æƒé™æ§åˆ¶ (âœ… å·²å®ç°)

**æè¿°**: é€šè¿‡YAMLé…ç½®æ–‡ä»¶å®šä¹‰è§’è‰²-è¡¨-æ“ä½œçš„æƒé™æ˜ å°„

**å®ç°æ–‡ä»¶**: [permission/mod.rs](file:///home/project/dbnexus/dbnexus/src/permission/mod.rs)

**æ£€æŸ¥ç»“æœ**:
- æƒé™é…ç½®ç»“æ„å·²å®Œæ•´å®šä¹‰ (Operation, TablePermission, RolePolicy, PermissionConfig) âœ…
- PermissionContext å·²å®ç° âœ…
- YAML é…ç½®è§£æå·²å®ç° âœ…
- æƒé™æ£€æŸ¥é€»è¾‘ allows() å’Œ check_table_access() å·²å®ç° âœ…
- Session åˆ›å»ºæ—¶è‡ªåŠ¨ç»‘å®šè§’è‰² âœ…
- æŸ¥è¯¢æ‰§è¡Œå‰è‡ªåŠ¨æ ¡éªŒæƒé™ âœ…
- æ— æƒé™æ“ä½œè¿”å› `PermissionDenied` é”™è¯¯ âœ…
- æƒé™é…ç½®è‡ªåŠ¨åŠ è½½æœºåˆ¶å·²å®ç° âœ…
- é›†æˆæµ‹è¯•ç”¨ä¾‹å®Œæ•´ âœ…

**ç¬¬1å±‚ - Entityæ˜ å°„**:

```rust
#[derive(DbEntity)]
#[db_entity]
#[table_name = "users"]
struct User {
    #[primary_key]
    id: i64,
    name: String,
}
```

**ç¬¬2å±‚ - CRUDå¢å¼º**:

```rust
#[db_crud]
// è‡ªåŠ¨ç”Ÿæˆ:
// User::insert(&session, user).await?
// User::find_by_id(&session, 1).await?
// User::update(&session, user).await?
// User::delete(&session, 1).await?
```

**ç¬¬3å±‚ - æƒé™å£°æ˜**:

```rust
#[db_permission(roles = ["admin", "user"])]
struct User { ... }
// åªæœ‰admin/userè§’è‰²å¯ä»¥è®¿é—®è¯¥è¡¨
```

**éªŒæ”¶æ ‡å‡†**:

- å®å±•å¼€åä»£ç å¯è¯»æ€§é«˜(é€šè¿‡cargo expandæ£€æŸ¥) âœ… å·²å®ç°
- ç¼–è¯‘æ—¶æ£€æŸ¥æƒé™è§’è‰²æ˜¯å¦åœ¨é…ç½®æ–‡ä»¶ä¸­å­˜åœ¨ âš ï¸ éƒ¨åˆ†å®ç° - æœ‰è§’è‰²éªŒè¯ä»£ç ,ä½†ä¸ºè¿è¡Œæ—¶æ£€æŸ¥
- ä¸»é”®å­—æ®µå¿…é¡»å”¯ä¸€,å¦åˆ™ç¼–è¯‘æŠ¥é”™ âœ… å·²å®ç°

**å®ç°æ–‡ä»¶**: [dbnexus-macros/src/lib.rs](file:///home/project/dbnexus/dbnexus-macros/src/lib.rs)

**æ£€æŸ¥ç»“æœ**:
- `dbnexus-macros` proc-macro crate å·²åˆ›å»º âœ…
- `#[db_entity]` å®å·²å®ç° - Entity æ˜ å°„ã€ActiveModel ç”Ÿæˆã€IntoActiveModel è½¬æ¢ âœ…
- `#[db_crud]` å®å·²å®ç° - è‡ªåŠ¨ç”Ÿæˆ insert/find_by_id/update/delete/find_all/count/delete_many æ–¹æ³• âœ…
- `#[db_permission]` å®å·²å®ç° - è§’è‰²æƒé™å£°æ˜ä¸éªŒè¯é€»è¾‘ç”Ÿæˆ âœ…
- ä¸»é”®å­—æ®µå”¯ä¸€æ€§æ£€æŸ¥å·²å®ç° âœ…
- table_name å’Œ primary_key å±æ€§è§£æå·²å®ç° âœ…

#### F5: é…ç½®ç®¡ç†ä¸è‡ªåŠ¨ä¿®æ­£ (âš ï¸ éƒ¨åˆ†å®ç°)

**æè¿°**: ä»TOML/YAMLåŠ è½½é…ç½®,æ£€æµ‹ä¸åˆç†å‚æ•°å¹¶è‡ªåŠ¨ä¿®æ­£

```toml
[database]
max_connections = 500  # å¦‚æœè¶…è¿‡æ•°æ®åº“èƒ½åŠ›,è‡ªåŠ¨ä¿®æ­£ä¸º200
min_connections = 5
idle_timeout = 300
```

#### F5: é…ç½®ç®¡ç†ä¸è‡ªåŠ¨ä¿®æ­£ (âš ï¸ éƒ¨åˆ†å®ç°)

**æè¿°**: ä»TOML/YAMLåŠ è½½é…ç½®,æ£€æµ‹ä¸åˆç†å‚æ•°å¹¶è‡ªåŠ¨ä¿®æ­£

```toml
[database]
max_connections = 500  # å¦‚æœè¶…è¿‡æ•°æ®åº“èƒ½åŠ›,è‡ªåŠ¨ä¿®æ­£ä¸º200
min_connections = 5
idle_timeout = 300
```

**ä¿®æ­£è§„åˆ™**:

1. æŸ¥è¯¢æ•°æ®åº“`SHOW VARIABLES LIKE 'max_connections'`
2. å¦‚æœ`max_connections` > æ•°æ®åº“èƒ½åŠ› * 0.8,ä¿®æ­£ä¸ºæ•°æ®åº“èƒ½åŠ› * 0.8
3. å¦‚æœ`min_connections` > `max_connections`,ä¿®æ­£ä¸º`max_connections` / 2
4. å¦‚æœ`idle_timeout` < 60ç§’,ä¿®æ­£ä¸º60ç§’
5. è®°å½•WARNINGæ—¥å¿—:`Config corrected: max_connections 500 -> 200`

**éªŒæ”¶æ ‡å‡†**:

- å¯åŠ¨æ—¶æ—¥å¿—è¾“å‡ºä¿®æ­£ä¿¡æ¯ âš ï¸ éƒ¨åˆ†å®ç° - æœ‰ info! æ—¥å¿—ä½†æ— ä¿®æ­£é€»è¾‘
- ä¿®æ­£åçš„å€¼å¯é€šè¿‡`DbPool::get_actual_config()`æŸ¥è¯¢ âŒ æœªå®ç° - æ— æ­¤æ–¹æ³•
- æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–é…ç½®æ–‡ä»¶ âœ… å·²å®ç° - from_env() æ–¹æ³•å­˜åœ¨

**å®ç°æ–‡ä»¶**: [config/mod.rs](file:///home/project/dbnexus/dbnexus/src/config/mod.rs)

**æ£€æŸ¥ç»“æœ**:
- DbConfig ç»“æ„å·²å®šä¹‰,åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ âœ…
- from_env() æ–¹æ³•å®ç°äº†ç¯å¢ƒå˜é‡åŠ è½½ âœ…
- from_yaml_file() / from_toml_file() æ–‡ä»¶åŠ è½½å·²å®ç° âœ…
- from_yaml_str() / from_toml_str() å­—ç¬¦ä¸²è§£æå·²å®ç° âœ…
- validate() é…ç½®éªŒè¯å·²å®ç° âœ…
- from_config_files() è‡ªåŠ¨åŠ è½½é…ç½®æ–‡ä»¶å·²å®ç° âœ…
- æ— é…ç½®è‡ªåŠ¨ä¿®æ­£é€»è¾‘ (ConfigCorrector) âŒ
- æ— æ•°æ®åº“èƒ½åŠ›æŸ¥è¯¢é€»è¾‘ âŒ
- æ—  get_actual_config() æ–¹æ³• âŒ

**è¯„ä¼°**: æ ¸å¿ƒé…ç½®åŠ è½½åŠŸèƒ½å·²å®ç°,é…ç½®æ–‡ä»¶è‡ªåŠ¨ä¿®æ­£åŠŸèƒ½ç¼ºå¤±,ç»´æŒéƒ¨åˆ†å®ç°çŠ¶æ€ã€‚

**æ ¸å¿ƒåŠŸèƒ½**:

- ä»Rust structè‡ªåŠ¨ç”ŸæˆCREATE TABLE SQL (âŒ æœªå®ç°)
- æ£€æµ‹structå˜æ›´,ç”ŸæˆALTER TABLE migration (âŒ æœªå®ç°)
- ç‰ˆæœ¬ç®¡ç†(è®°å½•å·²æ‰§è¡Œçš„migration) (âŒ æœªå®ç°)
- æ”¯æŒè”åˆç´¢å¼•/éƒ¨åˆ†ç´¢å¼•/å¤–é”®çº¦æŸ (âŒ æœªå®ç°)

**ä½¿ç”¨æµç¨‹**:

```bash
# 1. ç”Ÿæˆmigration
cargo db-migrate generate "add_users_table"

# 2. è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶:
# migrations/20250101_000001_add_users_table.sql

# 3. æ‰§è¡Œmigration
cargo db-migrate up
```

**éªŒæ”¶æ ‡å‡†**:

- æ£€æµ‹åˆ°structæ–°å¢å­—æ®µ,ç”ŸæˆADD COLUMN
- æ£€æµ‹åˆ°å­—æ®µç±»å‹å˜æ›´,ç”ŸæˆALTER COLUMN
- æ”¯æŒSQLite/PostgreSQL/MySQLçš„SQLæ–¹è¨€å·®å¼‚
- Migrationå†å²è®°å½•è¡¨:`schema_migrations(version, applied_at)`

**æ£€æŸ¥ç»“æœ**:
- migration æ¨¡å—å·²å®Œæ•´å®ç° âœ…
- DatabaseType æšä¸¾å·²å®ç° âœ…
- ColumnType/Column/Table/Index/ForeignKey ç»“æ„ä½“å·²å®ç° âœ…
- Schema ç»“æ„ä½“å·²å®ç° âœ…
- SchemaDiffer å·²å®ç°(åŒ…å«å·®å¼‚æ£€æµ‹) âœ…
- SqlGenerator å·²å®ç° âœ…
- æ”¯æŒä¸‰ç§æ•°æ®åº“æ–¹è¨€(PostgreSQL/MySQL/SQLite) âœ…
- æ—  dbnexus-migration CLI crate âŒ
- æ— ä» Rust struct è‡ªåŠ¨ç”Ÿæˆ migration çš„èƒ½åŠ› âŒ
- æ— ç‰ˆæœ¬ç®¡ç†(è®°å½•å·²æ‰§è¡Œçš„ migration) âŒ

**è¯„ä¼°**: æ ¸å¿ƒè¿ç§»é€»è¾‘å·²å®ç°,ç¼ºå°‘ CLI å·¥å…·å’Œä» struct è‡ªåŠ¨ç”Ÿæˆçš„èƒ½åŠ›,çŠ¶æ€ä»"æœªå®ç°"æå‡ä¸º"éƒ¨åˆ†å®ç°"ã€‚

#### F7: Prometheus Metricså¯¼å‡º (âœ… å·²å®ç°)
**ç›‘æ§æŒ‡æ ‡**:
```
# è¿æ¥æ± çŠ¶æ€
db_pool_connections{state="active"} 10
db_pool_connections{state="idle"} 15
db_pool_connections{state="total"} 25

# æŸ¥è¯¢å»¶è¿Ÿ(ç›´æ–¹å›¾)
db_query_duration_seconds{table="users",op="SELECT",quantile="0.5"} 0.005
db_query_duration_seconds{table="users",op="SELECT",quantile="0.95"} 0.050
db_query_duration_seconds{table="users",op="SELECT",quantile="0.99"} 0.100

# é”™è¯¯ç‡
db_errors_total{type="connection"} 3
db_errors_total{type="query"} 1

# æ…¢æŸ¥è¯¢
db_slow_queries_total{threshold="100ms"} 5
```

**å®ç°æ–‡ä»¶**: [metrics/mod.rs](file:///home/project/dbnexus/dbnexus/src/metrics/mod.rs)

**æ£€æŸ¥ç»“æœ**:
- MetricsCollector ç»“æ„ä½“å·²å®Œæ•´å®ç° âœ…
- è¿æ¥æ± çŠ¶æ€æŒ‡æ ‡ï¼špool_total, pool_active, pool_idle âœ…
- æŸ¥è¯¢æŒ‡æ ‡æ”¶é›†ï¼šQueryMetrics å®ç°äº†è®°å½•æŸ¥è¯¢å»¶è¿Ÿå’ŒæˆåŠŸç‡ âœ…
- é”™è¯¯ç»Ÿè®¡ï¼šconnection_errors, query_errors åŸå­è®¡æ•°å™¨ âœ…
- æ…¢æŸ¥è¯¢è®°å½•ï¼šslow_queries ç¯å½¢ç¼“å†²åŒºå®ç° âœ…
- Prometheus æ ¼å¼å¯¼å‡ºï¼šexport_prometheus() æ–¹æ³•å®ç°äº†æ ‡å‡†æ ¼å¼ âœ…
- æ”¯æŒæŒ‰æŸ¥è¯¢ç±»å‹åˆ†ç±»ç»Ÿè®¡ âœ…
- çº¿ç¨‹å®‰å…¨çš„åŸå­æ“ä½œå’ŒRwLockä¿æŠ¤ âœ…

**è¯„ä¼°**: å®Œæ•´å®ç°äº†æ‰€æœ‰PRDè¦æ±‚çš„ç›‘æ§æŒ‡æ ‡ï¼ŒåŒ…æ‹¬è¿æ¥æ± çŠ¶æ€ã€æŸ¥è¯¢å»¶è¿Ÿã€é”™è¯¯ç‡å’Œæ…¢æŸ¥è¯¢è®°å½•ï¼Œå¹¶æä¾›æ ‡å‡†çš„Prometheuså¯¼å‡ºæ ¼å¼ã€‚

**é›†æˆæ–¹å¼**:

```rust
// ç”¨æˆ·åœ¨è‡ªå·±çš„HTTP serverä¸­:
axum::Router::new()
    .route("/metrics", get(|| async {
        pool.export_metrics()
    }))
```

**éªŒæ”¶æ ‡å‡†**:

- è¿æ¥æ± çŠ¶æ€æŒ‡æ ‡å¯é‡‡é›† (active/idle/total) âŒ æœªå®ç°
- æŸ¥è¯¢å»¶è¿Ÿç›´æ–¹å›¾å¯é‡‡é›† âŒ æœªå®ç°
- é”™è¯¯ç‡è®¡æ•°å™¨å¯é‡‡é›† âŒ æœªå®ç°
- æ…¢æŸ¥è¯¢è®¡æ•°å™¨å¯é‡‡é›† âŒ æœªå®ç°
- export_metrics() æ–¹æ³•è¿”å›æ­£ç¡®æ ¼å¼ âŒ æœªå®ç°

**æ£€æŸ¥ç»“æœ**:
- é¡¹ç›®ä¸­æ—  metrics æ¨¡å—æˆ–ç›¸å…³ä»£ç  âŒ
- æ—  metrics ç»“æ„æˆ– MetricsRecorder âŒ
- æ—  prometheus_metrics() æ–¹æ³• âŒ
- æ— è¿æ¥æ± æŒ‡æ ‡æ”¶é›†é€»è¾‘ âŒ
- æ— æŸ¥è¯¢å»¶è¿Ÿè®°å½•é€»è¾‘ âŒ

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
- åˆ›å»º metrics æ¨¡å—
- å®ç° Metrics ç»“æ„
- å®ç°è¿æ¥æ± æŒ‡æ ‡æ”¶é›†
- å®ç°æŸ¥è¯¢å»¶è¿Ÿè®°å½•
- å®ç° export_metrics() æ–¹æ³•

------

### 2.2 é«˜çº§åŠŸèƒ½(v2.0+)

#### F8: åˆ†å¸ƒå¼è¿½è¸ª (âŒ æœªå®ç°)
**åŠŸèƒ½éœ€æ±‚**:
- OpenTelemetry SDK é›†æˆ
- Trace ID è‡ªåŠ¨æ³¨å…¥/æå–
- Span ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ä¸ä¸»æµè¿½è¸ªåç«¯å…¼å®¹(Jaeger/Zipkin/Cloud Trace)

#### F9: æ—¶é—´åˆ†ç‰‡(v2.0) (âŒ æœªå®ç°)

```rust
#[db_shard(field = "create_time", strategy = "yearly")]
struct Order { ... }
// è‡ªåŠ¨è·¯ç”±åˆ° db_2024 / db_2025
```

#### F10: å…¨å±€ç´¢å¼•è¡¨(v2.0) (âŒ æœªå®ç°)

- é€šè¿‡binlog/CDCå¼‚æ­¥åŒæ­¥
- æ”¯æŒä¸å¸¦æ—¶é—´æ¡ä»¶çš„æŸ¥è¯¢

#### F11: æ‰©å±•å®å±‚(v2.0) (âŒ æœªå®ç°)

- ç¬¬4å±‚: ç¼“å­˜ç­–ç•¥ `#[db_cache(ttl=300)]`
- ç¬¬5å±‚: å®¡è®¡æ—¥å¿— `#[db_audit]`
- ç¬¬6å±‚: å¤šç§Ÿæˆ· `#[db_tenant(field="tenant_id")]`
- ç¬¬7å±‚: åˆ†ç‰‡è§„åˆ™ `#[db_shard]`

#### F12: æ’ä»¶åŒ–æƒé™å¼•æ“(v2.0) (âŒ æœªå®ç°)

- æ”¯æŒè‡ªå®šä¹‰æƒé™ç­–ç•¥å®ç° `PermissionPolicy` trait
- æ”¯æŒåŸºäºå±æ€§(ABAC)çš„ç»†ç²’åº¦æ§åˆ¶
- æ”¯æŒåŠ¨æ€åŠ è½½å¤–éƒ¨æƒé™è§„åˆ™

------

## 3. éåŠŸèƒ½éœ€æ±‚

### 3.1 æ€§èƒ½æŒ‡æ ‡

- è¿æ¥æ± è·å–å»¶è¿Ÿ: P99 < 5ms
- æŸ¥è¯¢å»¶è¿Ÿå¼€é”€: ç›¸æ¯”åŸç”ŸSea-ORMå¢åŠ  < 1ms
- æƒé™æ£€æŸ¥å¼€é”€: < 0.1ms
- æ”¯æŒå¹¶å‘QPS: 100+(å•å®ä¾‹)

### 3.2 å®‰å…¨æ€§

- è¿æ¥å­—ç¬¦ä¸²ä¸åŒ…å«æ˜æ–‡å¯†ç (æ”¯æŒç¯å¢ƒå˜é‡)
- Sessionæ— æ³•ç»•è¿‡æƒé™æ£€æŸ¥
- SQLæ³¨å…¥é˜²æŠ¤(ä¾èµ–Sea-ORMå‚æ•°åŒ–æŸ¥è¯¢)

### 3.3 å¯ç»´æŠ¤æ€§

- ç¼–è¯‘æ—¶é”™è¯¯ä¿¡æ¯æ¸…æ™°(å®é”™è¯¯æç¤º)
- æ—¥å¿—åˆ†çº§: ERROR/WARN/INFO/DEBUG/TRACE
- æ–‡æ¡£è¦†ç›–ç‡100%(æ‰€æœ‰å…¬å¼€API)

### 3.4 å…¼å®¹æ€§

- Rustç‰ˆæœ¬: 1.75+
- Sea-ORMç‰ˆæœ¬: 1.0+
- æ•°æ®åº“ç‰ˆæœ¬:
  - SQLite 3.35+
  - PostgreSQL 12+
  - MySQL 8.0+

------

## 4. ç”¨æˆ·æ•…äº‹

### US1: å¿«é€Ÿä¸Šæ‰‹

**ä½œä¸º**åç«¯å¼€å‘è€…
 **æˆ‘æƒ³è¦**é€šè¿‡ç®€å•é…ç½®å³å¯ä½¿ç”¨æ•°æ®åº“
 **ä»¥ä¾¿äº**å¿«é€Ÿæ­å»ºåŸå‹

**éªŒæ”¶åœºæ™¯**:

```rust
// 1. å®šä¹‰Entity
#[derive(DbEntity)]
#[db_entity]
#[db_crud]
struct User {
    #[primary_key]
    id: i64,
    name: String,
}

// 2. åˆ›å»ºSession
let session = DbPool::get_session("admin").await?;

// 3. CRUDæ“ä½œ
User::insert(&session, user).await?;
let user = User::find_by_id(&session, 1).await?;
```

### US2: å®‰å…¨è®¿é—®

**ä½œä¸º**ç³»ç»Ÿç®¡ç†å‘˜
 **æˆ‘æƒ³è¦**é™åˆ¶åªè¯»è´¦å·ä¸èƒ½ä¿®æ”¹æ•°æ®
 **ä»¥ä¾¿äº**é˜²æ­¢è¯¯æ“ä½œå’Œè¶Šæƒè®¿é—®

**éªŒæ”¶åœºæ™¯**:

```yaml
# permissions.yaml (æ ‡å‡†æ ¼å¼)
roles:
  admin:
    tables:
      - name: "*"
        operations: ["SELECT", "INSERT", "UPDATE", "DELETE"]
  readonly:
    tables:
      - name: "users"
        operations: ["SELECT"]
      - name: "orders"
        operations: ["SELECT"]
  user:
    tables:
      - name: "users"
        operations: ["SELECT", "UPDATE"]
      - name: "orders"
        operations: ["SELECT", "INSERT"]
```

```rust
let session = DbPool::get_session("readonly").await?;
User::delete(&session, 1).await?; // è¿”å›PermissionDeniedé”™è¯¯
```

### US3: ç›‘æ§è§‚æµ‹

**ä½œä¸º**SREå·¥ç¨‹å¸ˆ
 **æˆ‘æƒ³è¦**æŸ¥çœ‹æ•°æ®åº“è¿æ¥æ± å’ŒæŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡
 **ä»¥ä¾¿äº**åŠæ—¶å‘ç°å’Œå®šä½é—®é¢˜

**éªŒæ”¶åœºæ™¯**:

```bash
curl http://localhost:9090/metrics | grep db_
# è¾“å‡ºPrometheusæ ¼å¼æŒ‡æ ‡
```

------

## 5. çº¦æŸä¸é™åˆ¶

### 5.1 æŠ€æœ¯çº¦æŸ

- å•ä¸ªSessionä¸æ”¯æŒè·¨æ•°æ®åº“å®ä¾‹æŸ¥è¯¢(éœ€è¦distributed transaction)
- å®ä¸æ”¯æŒæ³›å‹Entity(Rustå®ç³»ç»Ÿé™åˆ¶)
- Migrationä¸æ”¯æŒè‡ªåŠ¨æ•°æ®è¿ç§»(åªè¿ç§»schema)

### 5.2 ä¸šåŠ¡çº¦æŸ

- v1.0ä¸æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡
- v1.0ä¸æ”¯æŒè¡Œçº§æƒé™æ§åˆ¶
- v1.0è¯»å†™åˆ†ç¦»æ˜¯ç®€åŒ–å®ç°(5ç§’çª—å£)

------

## 6. å¼€å‘è·¯çº¿å›¾

### Phase 1: MVP (4å‘¨)

- Week 1-2: è¿æ¥æ±  + Sessionæœºåˆ¶ + ç¬¬1å±‚å®
- Week 3: æƒé™æ§åˆ¶ + é…ç½®ç®¡ç†
- Week 4: ç¬¬2-3å±‚å® + åŸºç¡€æµ‹è¯•

### Phase 2: ç”Ÿäº§å°±ç»ª (4å‘¨)

- Week 5-6: Migrationå·¥å…·(æ ¸å¿ƒåŠŸèƒ½)
- Week 7: Metricså¯¼å‡º + æ…¢æŸ¥è¯¢åˆ†æ
- Week 8: å®Œæ•´æµ‹è¯•å¥—ä»¶ + æ–‡æ¡£

### Phase 3: ä¼ä¸šç‰¹æ€§ (4å‘¨)

- Week 9-10: è¯»å†™åˆ†ç¦» + åŠ¨æ€é…ç½®
- Week 11: æ—¶é—´åˆ†ç‰‡(åŸºç¡€å®ç°)
- Week 12: æ€§èƒ½ä¼˜åŒ– + å‹æµ‹

------

## 7. æˆåŠŸæŒ‡æ ‡

### 7.1 æŠ€æœ¯æŒ‡æ ‡

-  ä»£ç è¦†ç›–ç‡ > 80%
-  æ‰€æœ‰å…¬å¼€APIæœ‰æ–‡æ¡£å’Œç¤ºä¾‹
-  é€šè¿‡100 QPSå‹æµ‹,P99å»¶è¿Ÿ < 10ms
-  è¿ç»­è¿è¡Œ24å°æ—¶æ— å†…å­˜æ³„æ¼

### 7.2 ç”¨æˆ·æŒ‡æ ‡

-  5åˆ†é’Ÿå†…å®Œæˆquickstartç¤ºä¾‹
-  Migrationå·¥å…·å¯æ­£ç¡®æ£€æµ‹90%+çš„schemaå˜æ›´
-  æƒé™é…ç½®é”™è¯¯åœ¨ç¼–è¯‘æ—¶å‘ç°(è¦†ç›–80%+åœºæ™¯)
