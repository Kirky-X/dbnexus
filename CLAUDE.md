# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

DB Nexus is an enterprise-grade database abstraction layer for Rust built on Sea-ORM. It provides:
- **Session Management**: RAII-style database connection lifecycle with automatic pool return
- **Permission Control**: Role-based table-level access control with YAML configuration
- **Connection Pooling**: Dynamic configuration with health checks and automatic tuning
- **Multi-Database Support**: SQLite, PostgreSQL, and MySQL with compile-time feature selection

## Build Commands

```bash
# Check compilation (all features)
cargo check --all-features --all

# Format code and check formatting
cargo fmt --all
cargo fmt --check --all

# Run clippy linter (strict mode)
cargo clippy --all-features --all -- -D warnings

# Run tests (select exactly one database)
cargo test --features sqlite --all
cargo test --features postgres --all
cargo test --features mysql --all

# Run a single test
cargo test --features sqlite -p dbnexus test_name

# Generate documentation
cargo doc --no-deps --all-features

# Build release
cargo build --release --features <sqlite|postgres|mysql>
```

## Database Feature Selection

The project requires exactly **one** database feature to be enabled at compile time:
- `sqlite` - SQLite via sqlx-sqlite
- `postgres` - PostgreSQL via sqlx-postgres
- `mysql` - MySQL via sqlx-mysql

These are mutually exclusive and will cause a compile error if multiple are enabled.

Optional features:
- `runtime-tokio-rustls` (default) - Tokio with RustLS
- `runtime-tokio-native-tls` - Tokio with native TLS
- `runtime-async-std` - Async-std runtime
- `metrics` - Prometheus metrics export
- `migration` - Database migration support
- `tracing` - Structured logging with tracing-subscriber

## Architecture

```
dbnexus/
├── src/
│   ├── lib.rs          # Main entry point, module declarations, macro re-exports
│   ├── config/         # DbConfig, DbError, environment loading
│   ├── pool/           # DbPool, connection management, pool status
│   ├── session/        # Session, transaction state, write-read tracking
│   ├── permission/     # RolePolicy, PermissionContext, Operation types
│   └── entity/         # Entity conversion utilities, Set, EntityTrait
├── dbnexus-macros/
│   └── src/lib.rs      # #[derive(DbEntity)], #[db_crud], #[db_permission] macros
└── examples/
    ├── quickstart.rs   # Basic CRUD operations example
    ├── permissions.rs  # Role-based access control example
    └── transactions.rs # Transaction management example
```

### Key Types

- `DbPool` - Manages database connections with min/max limits and idle timeout
- `Session` - RAII wrapper for database connection with transaction support and write tracking
- `DbConfig` - Database configuration with env var support and validation
- `PermissionContext` - Role-based permission checking for table operations
- `ActiveModel` - Generated by `#[derive(DbEntity)]` for CRUD operations
- `PoolStatus` - Connection pool status (total, active, idle connections)

### Macro System

**#[derive(DbEntity)]** - Maps Rust struct to Sea-ORM Entity
- Generates `EntityTrait` implementation
- Generates `ActiveModel` struct with `Set` fields
- Generates `IntoActiveModel` implementation
- Requires `#[table_name]` and `#[primary_key]` attributes

**#[db_crud]** - Generates CRUD methods for entities
- `insert(session, entity)` - Insert with auto-ID retrieval
- `find_by_id(session, id)` - Find by primary key
- `update(session, entity)` - Update record
- `delete(session, id)` - Delete by ID
- `find_all(session)` - Find all records
- `delete_many(session, filter)` - Batch delete
- `count(session)` - Count records
- Each method calls `check_permission()` before execution (uses default allow-all if not using #[db_permission])

**#[db_permission]** - Declare allowed roles and operations
- Parses `roles = ["admin", "user"]` parameter
- Generates `ALLOWED_ROLES` constant with allowed roles
- Generates `ALLOWED_OPERATIONS` constant with allowed operations
- Generates `check_permission(ctx)` method for role validation
- Generates `check_operation(ctx, operation)` method for operation validation

**Important**: Do NOT use `#[db_crud]` and `#[db_permission]` together on the same struct as they will cause duplicate implementation errors. Use `#[db_crud]` alone for basic CRUD operations, or implement custom permission checking manually.

Example (basic CRUD without permissions):
```rust
use dbnexus::{DbPool, DbEntity, db_crud};

#[derive(DbEntity)]
#[db_entity]
#[table_name = "users")]
#[db_crud]
struct User {
    #[primary_key]
    id: i64,
    name: String,
}
```

### Data Flow

1. Create `DbPool::new(url)` or `DbPool::with_config(config)`
2. Acquire `Session` via `pool.get_session(role)`
3. Perform database operations using Sea-ORM entities
4. Session automatically returns connection to pool on drop

## Code Style

- Rust Edition 2024
- 4-space indentation, max 120 character lines
- `#[allow(clippy::unwrap_used)]` permitted in test modules
- All public APIs must have documentation comments
- No `unsafe_code` permitted (enforced at crate level)

## Configuration Environment Variables

- `DATABASE_URL` - Connection string (required)
- `DB_MAX_CONNECTIONS` - Max pool size (default: 20)
- `DB_MIN_CONNECTIONS` - Min pool size (default: 5)
- `DB_IDLE_TIMEOUT` - Idle connection timeout in seconds (default: 300)
- `DB_ACQUIRE_TIMEOUT` - Connection acquire timeout in ms (default: 5000)
- `DB_PERMISSIONS_PATH` - Path to YAML permission configuration file
